const selfId = ""
const lastId = ""
async function main(e,t){function o(e,t){return new Promise(o=>{setTimeout(()=>{o(e())},t)})}function r(e){return[...e.matchAll(/\\"gameId\\":\\"([\w\d\-]*)\\",\\"gameMode\\":\\"Duels\\"/g)].map(e=>e[1])}function n(t){return btoa(`{"HashKey":{"S":"${e+"_activity"}"},"Created":{"S":"${t}"}}`)}async function a(e=1,t="",a=""){let s=a,p=[];for(let l=0;l<e;l++){console.log("Fetching page",l+1);let i="https://www.geoguessr.com/api/v4/feed/private";""!==s&&(i+="?paginationToken="+s);let u=await (await fetch(i)).json();if(0===u.entries.length){console.log("All data fetched.");break}if(p.push(...r(JSON.stringify(u))),p.includes(t))break;s=n(u.entries[u.entries.length-1].time.substring(0,23)+"Z"),await o(()=>console.log("Done"),500)}let d=p.filter((e,t,o)=>o.indexOf(e)===t);return d.includes(t)?d.slice(0,d.indexOf(t)):d}let s=await a(1e3,t),p={};async function l(t){let o={};o.id=t.gameId,o.rounds=t.currentRoundNumber,o.startDate=new Date(t.rounds[0].startTime).toLocaleString("en-US"),o.endDate=new Date(t.rounds[o.rounds-1].endTime).toLocaleString("en-US"),o.mode=t.options.competitiveGameMode;for(let r=0;r<2;r++){let n=t.teams[r];if(n.players[0].playerId===e){if(o.selfHp=n.health,null===n.players[0].progressChange)o.befElo=n.players[0].rating,o.aftElo=o.befElo;else{let a=n.players[0].progressChange.competitiveProgress||n.players[0].progressChange.rankedSystemProgress;null===a?(o.befElo=n.players[0].rating,o.aftElo=o.befElo):(o.befElo=a.ratingBefore,o.aftElo=a.ratingAfter)}[o.selfDist,o.selfTtg,o.selfCountries]=i(n.players[0].guesses,t.rounds,n.roundResults,t.teams[1-r].roundResults)}else{o.oppId=n.players[0].playerId,o.oppHp=n.health;let s=n.players[0].progressChange.competitiveProgress||n.players[0].progressChange.rankedSystemProgress;if(null===s?o.oppElo=n.players[0].rating:o.oppElo=s.ratingBefore,[o.oppDist,o.oppTtg,_nil]=i(n.players[0].guesses,t.rounds),!p[o.oppId]){let l=`https://www.geoguessr.com/api/v3/users/${o.oppId}`,u=await fetch(l,{credentials:"include"});if(u.status>=400){o.oppName="Deleted User",o.oppCountry="",o.oppBanned=!0,o.oppBlueCheck=!1,o.oppCreator=!1;continue}let d=await u.json();p[o.oppId]=d}let c=p[o.oppId];o.oppName=c.nick,o.oppCountry=c.countryCode,o.oppBanned=c.isBanned,o.oppBluecheck=(2&c.flair)!=0,o.oppCreator=c.isCreator}}return o}function i(e,t,o=null,r=null){let n=0,a=0,s=0,p={};for(let l of e){let i=l.roundNumber-1,u=(new Date(l.created)-new Date(t[i].startTime))/1e3;if(s++,n+=l.distance,a+=u,!o)continue;let d=t[i].panorama?.countryCode;""!==d&&(d in p||(p[d]=[0,0,0,0,0,0]),p[d][0]++,p[d][1]+=l.distance,p[d][2]+=u,o[i].healthAfter>=o[i].healthBefore?p[d][3]++:p[d][4]+=r[i].score-o[i].score,p[d][5]+=o[i].score-r[i].score)}return 0===s?["",""]:[n/s,a/s,Object.entries(p).map(e=>e[0]+","+e[1].join(",")).join(";")]}async function u(e){let t=[],r=0;for(let n of e){console.log(`Fetching duel #${r++} / ${e.length}`);try{let a=await fetch(`https://game-server.geoguessr.com/api/duels/${n}`,{credentials:"include"});a=await a.json();let s=await l(a);t.push(s),await o(()=>null,150)}catch(p){console.log(`Error fetching duel ${n}`)}}return t}let d={id:"ID",rounds:"# Rounds",startDate:"Start Date",endDate:"End Date",selfHp:"My Health",befElo:"Start ELO",aftElo:"End ELO",selfDist:"Avg Distance",selfTtg:"Avg TTG",oppId:"Opp ID",oppHp:"Opp Health",oppElo:"Opp ELO",oppDist:"Opp Distance",oppTtg:"Opp TTG",selfCountries:"Self Countries",mode:"Game Mode",oppName:"Opp Name",oppCountry:"Opp Country",oppBanned:"Opp Banned",oppBluecheck:"Opp Bluecheck",oppCreator:"Opp Creator"},c=await u(s),f=function e(t,o="	",r=d){let n="";for(let a of t=[...t]){for(let s in r)n+=a[s]+o;n+="\n"}return n}(c);return f}
await main(selfId, lastId)
